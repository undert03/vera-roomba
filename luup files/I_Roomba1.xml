<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<implementation>
  <specVersion>
    <major>0</major>
    <minor>1</minor>
  </specVersion>
  <settings>
    <protocol>cr</protocol>
  </settings>
  <startup>main</startup>
  <functions>
  
  local ROOMBA_SID = "urn:undertoe-us:serviceId:Roomba1"
  local HAD_SID = "urn:micasaverde-com:serviceId:HaDevice1"	
	local DEFAULT_ADDRESS = "Enter IP of Roowifi"
	local json = require("json-rw")
	local BatteryStatus = 0
	local OriginalPoll = 0
	local NormalPoll = 120
	local QuickPoll = 10
	local PendingCMDaction = "Nothing"
	local HTTPtimeout = 5
	local PollLongRunning = false
	local PollShortRunning = false
	local GUsername = ""
	local GPassword = ""
	local CmdStatusSaved = ""
	local ScheduleCleanStarted = false
	local ScheduleTimeoutDef = 7200
	local ScheduleLoop = 0
	local PingDownCount = 0
	local DEBUG = false
	
	local function log(text)
		local id = PARENT_DEVICE or "unknown"
		luup.log("Roomba Plugin #" .. id .. " " .. text)
  end
	
	local function Roomba_GetVar( VarName, DefaultVal )
		local Gval = luup.variable_get(ROOMBA_SID, VarName, parentDevice)
		if ( Gval == nil ) then
			luup.variable_set(ROOMBA_SID, VarName, DefaultVal, parentDevice)
			Gval = DefaultVal
		end
		return Gval
	end
	
	local function Roomba_URLauthPrefix(User, Pass)
		local addresspre = ""
		if ( User ~= "") then
			addresspre = User .. ":" .. Pass .."@"
			GUsername = User
			GPassword = Pass
		end
		
		return addresspre
	end

	local function RoombaPingStatus()
		if(DEBUG) then log("========= RoombaPingStatus ===========") end
		
		local PingStatus = Roomba_GetVar( "PingStatus", "down" )
		local address = Roomba_GetVar( "Address", DEFAULT_ADDRESS )
		local RtnStatus = false
		
		pingresponse = os.execute( "ping -c 1 " .. address )
		if (pingresponse == 0) then
			if (PingStatus == "down") then
				CmdStatusSaved = Roomba_GetVar( "CmdStatus", "" )
				luup.variable_set(ROOMBA_SID, "CmdStatus", CmdStatusSaved, parentDevice)
			end
			luup.variable_set(ROOMBA_SID, "PingStatus", "up", parentDevice)
			RtnStatus = false
		else
			local CmdStatus = Roomba_GetVar( "CmdStatus", "" )
			if ( CmdStatus ~= "IP Down") then
				CmdStatusSaved = CmdStatus
			end
			luup.variable_set(ROOMBA_SID,"PingStatus","down",parentDevice)
			luup.variable_set(ROOMBA_SID, "CmdStatus", "IP Down", parentDevice)
			RtnStatus = true
		end
		
		return RtnStatus
	end

	local function Rommba_HTTP_Command( CMD )
		if ( RoombaPingStatus() ) then
			log("FAILED: Rommba_HTTP_Command [".. CMD .."] IP is down")
			return false
		end
		local urlstatus = luup.inet.wget("http://" .. address .. "/roomba.cgi?button=" .. CMD, HTTPtimeout, GUsername, GPassword)
		if urlstatus ~= 0 then
			log("FAILED: Rommba_HTTP_Command [".. CMD .."] NO Response")
			return false
		end
		return true
	end

	local function Roomba_Schedule_Start()
		local ScheduledClean 	= Roomba_GetVar( "ScheduledClean", 0 )
		if ( (ScheduleCleanStarted ~= true) and (tonumber(ScheduledClean) == 1) ) then
			ScheduleCleanStarted = true
			-- Restart Schedule if already filled in
			luup.variable_set(ROOMBA_SID, "ScheduledCleanStatus", "Nothing", parentDevice)
			luup.variable_set(ROOMBA_SID, "ScheduledCleanStatus", "Started", parentDevice)
			
			-- Init the Timeout for schedule VAR ScheduleTimeout
			local STimeOut = Roomba_GetVar( "ScheduledCleanTimeOut", ScheduleTimeoutDef )
			luup.call_delay ("Roomba_Schedule_Timeout", tonumber(STimeOut), "")
			ScheduleLoop = 0
			return true
		else
			return false
		end
	end

	local function Roomba_Schedule_End( Docked, MotionStatus )
		
		if ( (Docked) and (MotionStatus == "Dock" ) and (ScheduleCleanStarted) ) then
			ScheduleCleanStarted = false
			luup.variable_set(ROOMBA_SID, "ScheduledClean", 0, parentDevice)
			luup.variable_set(ROOMBA_SID, "ScheduledCleanStatus", "Completed", parentDevice)
		 	return true
		end
		return false
	end
	
	local function Roomba_Schedule_Interupted()
		if ( ScheduleCleanStarted ) then
			ScheduleCleanStarted = false
			luup.variable_set(ROOMBA_SID, "ScheduledClean", 0, parentDevice)
			luup.variable_set(ROOMBA_SID, "ScheduledCleanStatus", "Interupted", parentDevice)
			log(" **SCHEDULED CLEAN** Event : Interupted")
			return true
		end
	end

	function Roomba_Schedule_Timeout()
		log(" ========== SCHEDULE TIME OUT! =============")
		if ( ScheduleCleanStarted ) then
			ScheduleCleanStarted = false
			luup.variable_set(ROOMBA_SID, "ScheduledClean", 0, parentDevice)
			luup.variable_set(ROOMBA_SID, "ScheduledCleanStatus", "Failed", parentDevice)
			log(" **SCHEDULED CLEAN** Event : Timed Out")
		end
	end
	
	function Roomba_Schedule_Watcher(Docked, MotionStatus)
		if(DEBUG) then log("========= Roomba_Schedule_Watcher ===========") end
		
		local ScheduledClean 	= Roomba_GetVar( "ScheduledClean", 0 )
		if (ScheduledClean == 0) then
			return true
		end
		
		if ( ScheduleCleanStarted ) then
			if ( ScheduleLoop > 3 ) then
				ScheduleLoop = 4
			else
				ScheduleLoop = ScheduleLoop + 1
			end
		end
		
		-- log("==========> Scheduled Clean [" .. ScheduledClean .. "] LOOP: [".. tostring(ScheduleLoop) .."] ===========")
		if ( RoombaPingStatus() ) then
			log("Can not connect: " .. address .. " Will try again later")
			return true
		end
		
		if ( Roomba_Schedule_Start() ) then
			log(" **SCHEDULED CLEAN** Event : Started")
			return true
		elseif ( ScheduleLoop > 2 ) then
			if( Roomba_Schedule_End( Docked, MotionStatus ) ) then
				log(" **SCHEDULED CLEAN** Event : Achieved!")
				return true
			end
		end
		return false
		
	end
	
	local function RoombaShortPoll()
		if(DEBUG) then log("========= RoombaShortPoll ===========") end

		luup.variable_set(ROOMBA_SID, "Poll", QuickPoll, parentDevice)
		if( not PollShortRunning ) then
			luup.call_delay ("GetRoombaDataShort", 1, "")
		end
	end

	local function RoombaShortPollReset()
		if(DEBUG) then log("========= RoombaShortPollReset ===========") end
		PendingCMDaction = "Nothing"
		luup.variable_set(ROOMBA_SID, "Poll", NormalPoll, parentDevice)
		return Poll
	end
		
	local function readRoombaSettings(parentDevice)
		if(DEBUG) then log("========= readRoombaSettings ===========") end
		
		local Address 				= Roomba_GetVar( "Address", DEFAULT_ADDRESS )
		local Poll 						= Roomba_GetVar( "Poll", NormalPoll )
		local Username 				= Roomba_GetVar( "Username", "admin")
		local Password 				= Roomba_GetVar( "Password", "roombawifi")
		local CmdStatus 			= Roomba_GetVar( "CmdStatus", "Device Setup")
		local SimpleStatus 		= Roomba_GetVar( "SimpleStatus", "")
		
		Roomba_GetVar( "ScheduledClean", 0 )
		Roomba_GetVar( "ScheduledCleanStatus", "Nothing" )
		Roomba_GetVar( "ScheduledCleanTimeOut", ScheduleTimeoutDef )

		Roomba_URLauthPrefix(Username, Password)		
		
		return Address, Poll, addresspre	
	end

	local function RoombaUpdateBatteryLevel()
		if(DEBUG) then log("========= RoombaUpdateBatteryLevel ===========") end
		local address, Poll, addresspre = readRoombaSettings(parentDevice)
		local PingStatus = luup.variable_get(ROOMBA_SID, "PingStatus", parentDevice)
		if ( RoombaPingStatus() ) then
			log("Can not connect: " .. address .. " Will try again in " .. Poll .. " seconds")
			return false
		end

		local JSONurl = "http://".. address .."/roomba.json"
		local status, result = luup.inet.wget(JSONurl, HTTPtimeout, GUsername, GPassword)
		if status == 0 then
			local data = json.decode(result)
			local Charge = data.response.r18.value
		 	local Capacity = data.response.r19.value
		 	BatteryStatus = (Charge / Capacity) * 100
		 	if(DEBUG) then log("Battery Level Updated | Real:" .. BatteryStatus .. " > Rounded:" .. math.floor(BatteryStatus) ) end
		 	luup.variable_set(HAD_SID, "BatteryLevel", math.floor(BatteryStatus), parentDevice)
		end
		return true
	end
	
	local function RoombaRobotStatus()
		if(DEBUG) then log("========= RoombaRobotStatus ===========") end
		local address, Poll, addresspre = readRoombaSettings(parentDevice)
		
		local MotionStatus = ""
		local StatusBox = ""
		local Docked = false
		local StatusLevel = 0
		local TargetLevel = 0
		local SimpleStatusTxt = ""
		
		local PrevSimpStatus = luup.variable_get(ROOMBA_SID, "SimpleStatus", parentDevice)
		
		local PingStatus = luup.variable_get(ROOMBA_SID, "PingStatus", parentDevice)
		if ( RoombaPingStatus() ) then
			log("Can not connect: " .. address .. " Will try again in " .. Poll .. " seconds")
			return true
		end
		
		-- Connect to Robot and read JSON
		local status, result = luup.inet.wget("http://".. address .."/roomba.json", HTTPtimeout, GUsername, GPassword)
		if status == 0 then
		
			local data = json.decode(result)
		 	local ChargeStatus = data.response.r14.value
		 	local CurrentValue = (data.response.r16.value * -1)
		 	local CliffSensor = (data.response.r4.value + data.response.r5.value)
		 	
		 	if(DEBUG) then log(" == Current: " .. CurrentValue .. " | Charge Status: " .. ChargeStatus .. " | Cliff : " .. CliffSensor) end
		 			 	
		 	if ( CliffSensor >= 2) then
		 		-- Robot is docked
		 		MotionStatus = "Dock"
		 		SimpleStatusTxt = "Docked"
		 		Docked = true
				StatusLevel = 0
				TargetLevel = 0
		 		if ( ChargeStatus == "1" ) then 
		 			StatusBox = "Charging??"
		 			TargetLevel = -75
		 			StatusLevel = -75
		 			SimpleStatusTxt = "Charging Error"
		 		elseif ( ChargeStatus == "2" ) then
		 			StatusBox = "Charging"
		 			TargetLevel = 0
		 			StatusLevel = 0
		 			SimpleStatusTxt = "Charging"
		 		elseif ( ChargeStatus == "3" ) then
		 			StatusBox = "Trickle Charge"
		 			TargetLevel = -50
		 			StatusLevel = -50
		 			SimpleStatusTxt = "Charging"
		 		elseif ( ChargeStatus == "4" ) then
		 			TargetLevel = 0
		 			StatusLevel = -25
		 			StatusBox = "Docked"
		 		else
		 			StatusBox = "NA [" .. ChargeStatus .."]"
		 		end
		 	elseif ( CurrentValue > 200 ) then
		 		Docked = false
		 		MotionStatus = "Clean"
		 		SimpleStatusTxt = "Cleaning"
				StatusLevel = 100
				TargetLevel = 100
		 		StatusBox = "Cleaning"
		 		if ( PendingCMDaction == "Dock") then
		 			StatusBox = "Docking.."
					StatusLevel = 50
					TargetLevel = 100
		 		end
		 	else
		 		Docked = false
		 		MotionStatus = "Pause"
		 		StatusBox = "Paused"
				StatusLevel = 125
				TargetLevel = 100
		 		if ( PendingCMDaction == "Dock") then
		 			StatusBox = "Docking.."
					StatusLevel = 50
					TargetLevel = 100
		 		elseif ( (PendingCMDaction == "Clean") and ( (PrevSimpStatus == "Docked") or (PrevSimpStatus == "Charging") ) ) then
		 			StatusBox = "Undocking"
					StatusLevel = 25
					TargetLevel = 100
				else
					SimpleStatusTxt = "Paused"
		 		end
		 	end
		 	
		 	
			-- Set Simple Status
			luup.variable_set(ROOMBA_SID, "SimpleStatus", SimpleStatusTxt, parentDevice)

			-- Handles Start and Stopping Scheduled Clean Triggers
			Roomba_Schedule_Watcher(Docked, MotionStatus)
			
			-- Handle Pending Commands
		 	if ( PendingCMDaction == MotionStatus) then
		 		if( DEBUG) then log("=== > PENDING CMD ACHIVED! ".. PendingCMDaction .. " Back to Normal Poll: " .. OriginalPoll ) end		 		
		 		RoombaShortPollReset()
		  else
		 		if( DEBUG) then log(" === > PENDING CMD NO GOOD [".. MotionStatus .." != ".. PendingCMDaction .."]") end
		 	end		 	
		 	
		 	return Docked, MotionStatus, StatusBox, TargetLevel, StatusLevel
		else
			log("JSON URL fetch error")
			return false
		end		

	end

	
	function GetRoombaData()
		if( DEBUG) then log("========= GetRoombaData ===========") end
		local address, Poll, addresspre = readRoombaSettings(parentDevice)

		if( tostring(Poll) == tostring(QuickPoll) ) then
			luup.call_delay ("GetRoombaData", 120, "")
			return true
		end
		
		local Docked, MotionStatus, StatusTxt, TargetLevel, StatusLevel = RoombaRobotStatus()
		luup.variable_set(ROOMBA_SID, "CmdStatus", StatusTxt, parentDevice)
		
		luup.variable_set(ROOMBA_SID, "LoadlevelTarget", TargetLevel, parentDevice)
    luup.variable_set(ROOMBA_SID, "LoadLevelStatus", StatusLevel, parentDevice)
    
		RoombaUpdateBatteryLevel()
		
		luup.call_delay ("GetRoombaData", tonumber(Poll), "")
	end

	function GetRoombaDataShort()
		if( DEBUG) then log("========= GetRoombaDataShort ===========") end
			
		local address, Poll, addresspre = readRoombaSettings(parentDevice)
		if( tostring(Poll) ~= tostring(QuickPoll) ) then
			return true
		end
		
		PollLongRunning = true
		local Docked, MotionStatus, StatusTxt, TargetLevel, StatusLevel = RoombaRobotStatus()
		luup.variable_set(ROOMBA_SID, "CmdStatus", StatusTxt, parentDevice)
		
		luup.variable_set(ROOMBA_SID, "LoadlevelTarget", TargetLevel, parentDevice)
    luup.variable_set(ROOMBA_SID, "LoadLevelStatus", StatusLevel, parentDevice)
    
		RoombaUpdateBatteryLevel()
		luup.call_delay ("GetRoombaDataShort", tonumber(Poll), "")
	end
			
	function RoombaUp()
		if(DEBUG) then log("========= RoombaUp ===========") end	
		
		local PingStatus = Roomba_GetVar( "PingStatus", "down" )
		local address = Roomba_GetVar( "Address", DEFAULT_ADDRESS )

		pingresponse = os.execute("ping -c 1 " .. address)
		if (pingresponse == 0) then
			if (PingStatus == "down") then
				luup.variable_set(ROOMBA_SID, "CmdStatus", CmdStatusSaved, parentDevice)
			end
			luup.variable_set(ROOMBA_SID,"PingStatus","up",parentDevice)
			if( DEBUG) then log("Ping reply ") end
			PingDownCount = 0
			luup.call_delay("RoombaUp", 120, "")
			return true
		else
			PingDownCount = PingDownCount + 1
			
			if( PingDownCount > 3 ) then
				local CmdStatus = Roomba_GetVar( "CmdStatus", "" )
				if ( CmdStatus ~= "IP Down") then
					CmdStatusSaved = CmdStatus
				end
				luup.variable_set(ROOMBA_SID,"PingStatus","down",parentDevice)
				luup.variable_set(ROOMBA_SID, "CmdStatus", "IP Down", parentDevice)
			end
			
			log("No ping reply : " .. address .." PingDownCount : " .. tostring(PingDownCount) )
			
			if ( PingDownCount > 6) then
				luup.call_delay("RoombaUp", 60, "")
			elseif ( PingDownCount > 12 ) then
				luup.call_delay("RoombaUp", 120, "")
			else
				luup.call_delay("RoombaUp", 20, "")
			end
			
			return false
		end
	end
		
	local function RoombaClean()
		if( DEBUG) then log(" ====== RoombaClean ===========") end
		
		local address, Poll, addresspre = readRoombaSettings(parentDevice)
		local Docked, MotionStatus, StatusTxt = RoombaRobotStatus()
		
		if( MotionStatus == "Clean") then
			PendingCMDaction = "Pause"
			Roomba_Schedule_Interupted()
		else
			PendingCMDaction = "Clean"
		end
		
		luup.inet.wget("http://" .. address .. "/roomba.cgi?button=CLEAN", HTTPtimeout, GUsername, GPassword)
		RoombaShortPoll()
	end	
	
	local function RoombaDock()
		if( DEBUG) then log(" ====== RoombaDock ===========") end
		local address, Poll, addresspre = readRoombaSettings(parentDevice)
		local Docked, MotionStatus, StatusTxt = RoombaRobotStatus()
		
		if (Docked) then
			-- Just for shits and giggles
			PendingCMDaction = "Dock"
			RoombaShortPoll()
			return true
		end
		
		if ( MotionStatus ~= "Pause") then
			luup.inet.wget("http://" .. address .. "/roomba.cgi?button=CLEAN", HTTPtimeout, GUsername, GPassword )
			luup.sleep(2500)
		end
		luup.inet.wget("http://" .. address .. "/roomba.cgi?button=DOCK", HTTPtimeout, GUsername, GPassword )
		
		PendingCMDaction = "Dock"
		Roomba_Schedule_Interupted()
		
		RoombaShortPoll()
	end

	function main(parentDevice)
    PARENT_DEVICE = parentDevice

    log("VERSION 1.4.4 starting up..")
		if( DEBUG) then log("DEBUG : ENABLED!") end
			
	  luup.variable_set(HAD_SID, "LastUpdate", os.time(os.date('*t')), parentDevice)
    luup.variable_set(HAD_SID, "Configured", "1", parentDevice)
	  
	  -- TESTIN REMOVE ME
	  luup.variable_set(ROOMBA_SID, "ScheduledClean", 0, parentDevice)
	  
    local address = readRoombaSettings(parentDevice)

    if ( (address == nil) or (address == DEFAULT_ADDRESS) ) then
      if( DEBUG) then log("could not be started.") end
      luup.set_failure(true, parentDevice)
      luup.variable_set(ROOMBA_SID, "CmdStatus", "Set your IP", parentDevice)
      return false
    end
      
    luup.variable_set(ROOMBA_SID, "Poll", "120", parentDevice)
      
	 	luup.call_delay ("GetRoombaData", 1, "")
	  luup.call_delay("RoombaUp", 1, "")
		
		-- taskHandle = luup.task(text, (mode == TASK_ERROR_PERM) and TASK_ERROR or mode, MSG_CLASS, taskHandle)		
    return true
  end

  </functions>

  <actionList>
    <action>
		<serviceId>urn:undertoe-us:serviceId:Roomba1</serviceId>
		<name>Clean</name>
		<job>
			RoombaClean()
		</job>
	</action>
	
	<action>
		<serviceId>urn:undertoe-us:serviceId:Roomba1</serviceId>
		<name>Dock</name>
		<job>
			RoombaDock()
		</job>
	</action>

    <action>
      <serviceId>urn:undertoe-us:serviceId:Roomba1</serviceId>
      <name>GetAddress</name>
      <run>
        luup.variable_get(ROOMBA_SID, "Address", parentDevice)
      </run>
    </action>
    <action>
      <serviceId>urn:undertoe-us:serviceId:Roomba1</serviceId>
      <name>SetAddress</name>
      <run>
        luup.variable_set(ROOMBA_SID, "Address", lul_settings.newAddressValue, parentDevice)
      </run>
    </action>
  </actionList>
</implementation>
